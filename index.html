<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å±‹å°éƒ¨ å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
    <style>
      :root {
        --primary: #0083b0;
        --primary-light: #00b4db;
        --bg: #eef3f7;
        --text: #333;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: var(--bg);
        color: var(--text);
        font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      header {
        width: 100%;
        padding: 16px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
        background: linear-gradient(135deg, var(--primary-light), var(--primary));
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      main {
        width: min(640px, 92%);
        margin: 24px auto;
        padding: 24px 20px 32px;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .selector {
        display: grid;
        gap: 12px;
      }

      label {
        font-size: 1rem;
        text-align: left;
      }

      select {
        width: 100%;
        padding: 12px;
        font-size: 1.2rem;
        border: 2px solid #d5dbe3;
        border-radius: 10px;
        background: #f8fafc;
        transition: border 0.2s ease;
      }

      select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 4px rgba(0, 131, 176, 0.15);
      }

      #boothDisplay {
        font-weight: 600;
        font-size: 1.1rem;
        margin-top: 4px;
      }

      #cameraInput {
        display: none;
      }

      label.camera-button {
        display: inline-block;
        padding: 16px 40px;
        font-size: 1.3rem;
        font-weight: 600;
        color: #fff;
        background: var(--primary);
        border-radius: 999px;
        cursor: pointer;
        box-shadow: 0 10px 20px rgba(0, 131, 176, 0.25);
        transition: transform 0.15s ease, background 0.2s ease;
        align-self: center;
      }

      label.camera-button:hover {
        background: var(--primary-light);
        transform: translateY(-1px);
      }

      label.camera-button:active {
        transform: translateY(0);
      }

      label.camera-button.disabled {
        background: #97a4b1;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      #status {
        min-height: 1.5em;
        font-size: 1rem;
        line-height: 1.6;
        word-break: break-word;
      }

      #status.loading::after {
        content: "â€¦";
        animation: blink 1s infinite steps(1, end);
      }

      @keyframes blink {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.2;
        }
      }

      footer {
        margin-top: auto;
        padding: 20px 0 24px;
        font-size: 0.9rem;
        color: #6c7a89;
      }
    </style>
  </head>
  <body>
    <header>å±‹å°éƒ¨ å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</header>
    <main>
      <section class="selector">
        <label for="area">ã‚¨ãƒªã‚¢</label>
        <select id="area">
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="G">G</option>
          <option value="H">H</option>
          <option value="I">I</option>
          <option value="J">J</option>
        </select>

        <label for="number">ç•ªå·</label>
        <select id="number">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
        </select>

        <p id="boothDisplay">é¸æŠä¸­ã®å±‹å°: A01</p>
      </section>

      <input type="file" id="cameraInput" accept="image/*" capture="environment">
      <label class="camera-button" for="cameraInput" id="cameraTrigger">ğŸ“· æ’®å½±ã™ã‚‹</label>

      <p id="status" aria-live="polite"></p>
    </main>
    <footer>Â© 2025 å±‹å°éƒ¨ Photo Upload System</footer>

    <script>
      // å…¬é–‹ä¸­ã® Web ã‚¢ãƒ—ãƒª URLï¼ˆãƒ­ãƒ¼ã‚«ãƒ«è¡¨ç¤ºæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbz11iRonpmt7WbZIDbU4Sz16vq4LN9i0-lJpRV_L6_fCdmkexDVn-HV3g0hZMrQ5krD6Q/exec';
      const areaSelect = document.getElementById('area');
      const numberSelect = document.getElementById('number');
      const boothDisplay = document.getElementById('boothDisplay');
      const cameraInput = document.getElementById('cameraInput');
      const cameraTrigger = document.getElementById('cameraTrigger');
      const status = document.getElementById('status');

      // å±‹å°ç•ªå·ã®ä¸‹2æ¡ã‚’ã‚¼ãƒ­åŸ‹ã‚ã™ã‚‹
      const padNumber = (value) => value.toString().padStart(2, '0');

      const getBoothCode = () => {
        const area = areaSelect.value;
        const number = padNumber(numberSelect.value);
        return area + number;
      };

      const updateDisplay = () => {
        boothDisplay.textContent = 'é¸æŠä¸­ã®å±‹å°: ' + getBoothCode();
      };

      const setUploadingState = (isUploading) => {
        areaSelect.disabled = isUploading;
        numberSelect.disabled = isUploading;
        cameraInput.disabled = isUploading;
        cameraTrigger.classList.toggle('disabled', isUploading);
        if (isUploading) {
          cameraTrigger.setAttribute('aria-disabled', 'true');
        } else {
          cameraTrigger.removeAttribute('aria-disabled');
        }
      };

      areaSelect.addEventListener('change', updateDisplay);
      numberSelect.addEventListener('change', updateDisplay);

      // GAS åŸ‹ã‚è¾¼ã¿å†…ã‹ã©ã†ã‹åˆ¤å®šã™ã‚‹
      const inGasContext = () => typeof google !== 'undefined' && google.script && google.script.run;

      const performUpload = (dataUrl, boothCode) => {
        if (inGasContext()) {
          // GAS å†…ã§å‹•ä½œã—ã¦ã„ã‚‹å ´åˆã¯ google.script.run ã‚’åˆ©ç”¨
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler((error) => {
                reject(error && error.message ? error.message : JSON.stringify(error));
              })
              .uploadFile(dataUrl, boothCode);
          });
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã¯ Web ã‚¢ãƒ—ãƒª URL ã¸ fetch ã™ã‚‹
        return fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ data: dataUrl, boothCode })
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error('ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            return response.json();
          })
          .then((result) => {
            if (result && result.success) {
              return result.message;
            }
            throw new Error(result && result.message ? result.message : 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          });
      };

      cameraInput.addEventListener('change', () => {
        const file = cameraInput.files[0];
        if (!file) {
          return;
        }

        const boothCode = getBoothCode();
        if (!boothCode) {
          status.textContent = 'å±‹å°ç•ªå·ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
          cameraInput.value = '';
          return;
        }

        setUploadingState(true);
        status.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­';
        status.classList.add('loading');

        const reader = new FileReader();

        reader.onerror = () => {
          status.classList.remove('loading');
          status.textContent = 'ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦æ’®å½±ã—ã¦ãã ã•ã„ã€‚';
          setUploadingState(false);
          cameraInput.value = '';
        };

        reader.onloadend = () => {
          if (reader.error || !reader.result) {
            return;
          }
          performUpload(reader.result, boothCode)
            .then((message) => {
              status.classList.remove('loading');
              status.textContent = message || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
            })
            .catch((error) => {
              status.classList.remove('loading');
              const rawMessage = typeof error === 'string' ? error : (error && error.message ? error.message : 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
              const isNetworkError = /load failed/i.test(rawMessage) || rawMessage === 'TypeError: Failed to fetch';
              const friendlyMessage = isNetworkError
                ? 'GAS ã¸ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é›»æ³¢çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹ã‹ã€<a href="' + GAS_URL + '" target="_blank" rel="noopener">ã“ã¡ã‚‰ã® URL</a> ã‚’é–‹ã„ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚'
                : rawMessage;
              if (isNetworkError) {
                status.innerHTML = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + friendlyMessage;
              } else {
                status.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + rawMessage;
              }
            })
            .finally(() => {
              setUploadingState(false);
              cameraInput.value = '';
            });
        };

        reader.readAsDataURL(file);
      });

      updateDisplay();
    </script>
  </body>
</html>
