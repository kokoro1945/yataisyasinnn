<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Â±ãÂè∞ÈÉ® ÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„ÉÄ„Éº</title>
    <style>
      :root {
        --primary: #0083b0;
        --primary-light: #00b4db;
        --bg: #eef3f7;
        --text: #333;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: var(--bg);
        color: var(--text);
        font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      header {
        width: 100%;
        padding: 16px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
        background: linear-gradient(135deg, var(--primary-light), var(--primary));
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      main {
        width: min(640px, 92%);
        margin: 24px auto;
        padding: 24px 20px 32px;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .selector {
        display: grid;
        gap: 12px;
      }

      label {
        font-size: 1rem;
        text-align: left;
      }

      select {
        width: 100%;
        padding: 12px;
        font-size: 1.2rem;
        border: 2px solid #d5dbe3;
        border-radius: 10px;
        background: #f8fafc;
        transition: border 0.2s ease;
      }

      select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 4px rgba(0, 131, 176, 0.15);
      }

      #boothDisplay {
        font-weight: 600;
        font-size: 1.1rem;
        margin-top: 4px;
      }

      #cameraInput {
        display: none;
      }

      label.camera-button {
        display: inline-block;
        padding: 16px 40px;
        font-size: 1.3rem;
        font-weight: 600;
        color: #fff;
        background: var(--primary);
        border-radius: 999px;
        cursor: pointer;
        box-shadow: 0 10px 20px rgba(0, 131, 176, 0.25);
        transition: transform 0.15s ease, background 0.2s ease;
        align-self: center;
      }

      label.camera-button:hover {
        background: var(--primary-light);
        transform: translateY(-1px);
      }

      label.camera-button:active {
        transform: translateY(0);
      }

      label.camera-button.disabled {
        background: #97a4b1;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      #status {
        min-height: 1.5em;
        font-size: 1rem;
        line-height: 1.6;
        word-break: break-word;
      }

      #status.loading::after {
        content: "‚Ä¶";
        animation: blink 1s infinite steps(1, end);
      }

      @keyframes blink {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.2;
        }
      }

      footer {
        margin-top: auto;
        padding: 20px 0 24px;
        font-size: 0.9rem;
        color: #6c7a89;
      }
    </style>
  </head>
  <body>
    <header>Â±ãÂè∞ÈÉ® ÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„ÉÄ„Éº</header>
    <main>
      <section class="selector">
        <label for="area">„Ç®„É™„Ç¢</label>
        <select id="area">
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="G">G</option>
          <option value="H">H</option>
          <option value="I">I</option>
          <option value="J">J</option>
        </select>

        <label for="number">Áï™Âè∑</label>
        <select id="number">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
        </select>

        <p id="boothDisplay">ÈÅ∏Êäû‰∏≠„ÅÆÂ±ãÂè∞: A01</p>
      </section>

      <input type="file" id="cameraInput" accept="image/*" capture="environment">
      <label class="camera-button" for="cameraInput" id="cameraTrigger">üì∑ ÊíÆÂΩ±„Åô„Çã</label>

      <p id="status" aria-live="polite"></p>
    </main>
    <footer>¬© 2025 Â±ãÂè∞ÈÉ® Photo Upload System</footer>

    <script>
      // ÂÖ¨Èñã‰∏≠„ÅÆ Web „Ç¢„Éó„É™ URLÔºà„É≠„Éº„Ç´„É´Ë°®Á§∫ÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®Ôºâ
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbwGzPQlKZJWt0s3j8U-eC4b9Yck1KJf91Sa9pXGwE1c1viRnx4emVMSuZU7Q1nc7TJZ4A/exec';
      const areaSelect = document.getElementById('area');
      const numberSelect = document.getElementById('number');
      const boothDisplay = document.getElementById('boothDisplay');
      const cameraInput = document.getElementById('cameraInput');
      const cameraTrigger = document.getElementById('cameraTrigger');
      const status = document.getElementById('status');

      // Â±ãÂè∞Áï™Âè∑„ÅÆ‰∏ã2Ê°Å„Çí„Çº„É≠Âüã„ÇÅ„Åô„Çã
      const padNumber = (value) => value.toString().padStart(2, '0');

      const getBoothCode = () => {
        const area = areaSelect.value;
        const number = padNumber(numberSelect.value);
        return area + number;
      };

      const updateDisplay = () => {
        boothDisplay.textContent = 'ÈÅ∏Êäû‰∏≠„ÅÆÂ±ãÂè∞: ' + getBoothCode();
      };

      const setUploadingState = (isUploading) => {
        areaSelect.disabled = isUploading;
        numberSelect.disabled = isUploading;
        cameraInput.disabled = isUploading;
        cameraTrigger.classList.toggle('disabled', isUploading);
        if (isUploading) {
          cameraTrigger.setAttribute('aria-disabled', 'true');
        } else {
          cameraTrigger.removeAttribute('aria-disabled');
        }
      };

      areaSelect.addEventListener('change', updateDisplay);
      numberSelect.addEventListener('change', updateDisplay);

      // GAS Âüã„ÇÅËæº„ÅøÂÜÖ„Åã„Å©„ÅÜ„ÅãÂà§ÂÆö„Åô„Çã
      const inGasContext = () => typeof google !== 'undefined' && google.script && google.script.run;

      const performUpload = (dataUrl, boothCode) => {
        if (inGasContext()) {
          // GAS ÂÜÖ„ÅßÂãï‰Ωú„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ google.script.run „ÇíÂà©Áî®
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler((error) => {
                reject(error && error.message ? error.message : JSON.stringify(error));
              })
              .uploadFile(dataUrl, boothCode);
          });
        }

        // „É≠„Éº„Ç´„É´„ÇÑ„Éó„É¨„Éì„É•„ÉºÊôÇ„ÅØ Web „Ç¢„Éó„É™ URL „Å∏ fetch „Åô„Çã
        return fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ data: dataUrl, boothCode })
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error('„Çµ„Éº„Éê„Éº„Å∏„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
            return response.json();
          })
          .then((result) => {
            if (result && result.success) {
              return result.message;
            }
            throw new Error(result && result.message ? result.message : '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
          });
      };

      cameraInput.addEventListener('change', () => {
        const file = cameraInput.files[0];
        if (!file) {
          return;
        }

        const boothCode = getBoothCode();
        if (!boothCode) {
          status.textContent = 'Â±ãÂè∞Áï™Âè∑„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          cameraInput.value = '';
          return;
        }

        setUploadingState(true);
        status.textContent = '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠';
        status.classList.add('loading');

        const reader = new FileReader();

        reader.onerror = () => {
          status.classList.remove('loading');
          status.textContent = 'ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊíÆÂΩ±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          setUploadingState(false);
          cameraInput.value = '';
        };

        reader.onloadend = () => {
          if (reader.error || !reader.result) {
            return;
          }
          performUpload(reader.result, boothCode)
            .then((message) => {
              status.classList.remove('loading');
              status.textContent = message || '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ';
            })
            .catch((error) => {
              status.classList.remove('loading');
              const rawMessage = typeof error === 'string' ? error : (error && error.message ? error.message : '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
              const isNetworkError = /load failed/i.test(rawMessage) || rawMessage === 'TypeError: Failed to fetch';
              const friendlyMessage = isNetworkError
                ? 'GAS „Å∏„ÅÆÈÄö‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÈõªÊ≥¢Áä∂Ê≥Å„ÇíÁ¢∫Ë™ç„Åô„Çã„Åã„ÄÅÁõ¥Êé•„Åì„Å°„Çâ„ÅÆ URL „ÇíÈñã„ÅÑ„Å¶„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ\n' + GAS_URL
                : rawMessage;
              status.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + friendlyMessage;
            })
            .finally(() => {
              setUploadingState(false);
              cameraInput.value = '';
            });
        };

        reader.readAsDataURL(file);
      });

      updateDisplay();
    </script>
  </body>
</html>
