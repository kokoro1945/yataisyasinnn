# 実装計画（design.md / spec.md 準拠・マップ機能なし）
<!-- コメント: design.md に沿い、屋台番号選択と撮影アップロード機能に集中した流れを整理 -->

## 0. ゴールと方針
- スマートフォンで屋台番号（例: A01, A02 ...）を選択し、その場で撮影した写真を Google Drive の指定フォルダへアップロードできる。
- ファイル命名は `A01_YYYYMMDD_HHMMSS(_連番).jpg` に統一し、同じ屋台番号で複数枚アップする際は `_2`, `_3` ... を自動付与する。
- Google Apps Script (GAS) をバックエンドとし、`index.html` の UI と `Code.gs` の処理で完結させる。

## 1. 初期設定
1. Drive の保存フォルダ ID を決めて `Code.gs` の定数へ設定。
   - コメント: 共有運用を見据えるなら `PropertiesService` への移行も検討しておく。
2. GAS プロジェクトのタイムゾーンを JST に設定（命名日時の整合性確保）。
3. デプロイ設定を確認（「自分として実行」「アクセス権: 運用ポリシーに合わせる」）。

## 2. バックエンド実装（Code.gs）
1. `doGet` で `index.html` を返却する処理を確認／コメント整備。
2. `uploadFile(data, boothCode)` を屋台番号仕様に合わせて改造。
   - 入力チェック: `data` が Base64 URL 形式か、`boothCode` が `^[A-J]\d{2}$` 等の正規表現に合致するか検証。
   - 命名: `boothCode` + `_` + `yyyyMMdd_HHmmss` を基本とし、同一屋台・同一日付時刻で既存ファイルを探索して `_2` 以降を付与。
     - コメント: `getFilesByName` では完全一致になるので、`folder.getFiles()` でプレフィックス一致チェックを行う。
   - Blob 作成: `Utilities.base64Decode` → `Utilities.newBlob` → `folder.createFile`。
   - レスポンス: 成功時はファイル名を返し、失敗時はユーザー向け短文 + `console.error` で詳細ログ。

## 3. フロントエンド刷新（index.html）
1. 屋台番号選択 UI を設計。
   - 案A: エリアセレクト（A〜J）と番号セレクト（01〜20）を組み合わせて `A01` を生成。
   - 案B: 事前定義リストから `A01`, `A02` を直接選ばせるシングルセレクト。
   - コメント: 運用メンバーが直感的に扱える方式を選定。選択中の屋台番号が常に表示されるようにする。
2. 撮影・アップロード制御を調整。
   - `input type="file"` に `accept="image/*"` と `capture="environment"`（端末対応状況を考慮）を設定。
   - ファイル選択後に `FileReader` で Base64 化し、`google.script.run.uploadFile(reader.result, boothCode)` を呼び出す。
   - コメント: 屋台番号未選択時は送信させず、エラー表示で選択を促す。
3. ステータス表示を整理。
   - アップロード中は「📤 アップロード中...」＋アニメーション。
   - 完了時はファイル名を含む成功メッセージ。
   - エラー時は再試行方法を明記し、ボタンを再有効化。

## 4. UX 改善ポイント
1. 二重送信防止: 処理中は撮影ラベル・セレクトを `disabled` にする。
2. ボタン／メッセージに簡潔なコメントを添え、今後の調整箇所を明確化。
3. 操作ログやトースト通知が必要になった場合に備え、`status` 領域を単一責務に保つ。

## 5. 命名規則と Drive の確認
1. 実際にアップロードして `A01_20251025_191030.jpg` → `A01_20251025_191030_2.jpg` のように命名されるか確認。
2. 将来的にフォルダ階層を分けたい場合（例: `A/A01/`）の TODO コメントを `Code.gs` に残しておく。
3. 大容量画像や EXIF の向きズレへの対応は別タスクとして記録（任意実装箇所）。

## 6. デプロイとテスト
1. ウェブアプリとして新たにデプロイし、URL を共有。
2. 実機テスト (iOS Safari / Android Chrome) で以下を確認。
   - 屋台番号選択 → 撮影 → アップロードがスムーズか。
   - 連番付与が期待どおりに動作するか。
   - ネットワーク不安定時に適切なエラー表示と再送が可能か。
3. テスト結果を `design.md` または別途チェックリストに追記。

## 7. チェックリスト
- [ ] `Code.gs` に屋台番号形式のバリデーションと連番命名ロジックを実装。
- [ ] `index.html` で屋台番号選択 UI が整備され、未選択時の送信防止がある。
- [ ] アップロード処理中の UI ロック・ステータス表示が実装されている。
- [ ] 実ファイルの命名規則が Drive 上で確認できた。
- [ ] デプロイ設定とアクセス権が運用ポリシーに合致する。
- [ ] iOS / Android での手動テスト結果を記録した。

## 8. 将来拡張メモ
- 屋台番号一覧の管理を GAS Properties やスプレッドシートで柔軟化。
- アップロード完了ログをスプレッドシートへ保存。
- 画像圧縮・EXIF 補正・複数枚連続アップロードへの対応。
- 利用履歴の可視化や通知機能の追加。

---

<!-- コメント: マップ機能を排除しつつ、design.md の屋台番号命名規則とアップロード要件を確実に実装できる構成 -->
